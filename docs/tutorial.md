# Tutorials

In this section we will run {{ software_name }} on small example datasets. To be able to follow the tutorials make sure you completed all the steps in the [Getting started](setup.md) section.

## Basic usage

A single nuclei dataset for this tutorial was generated by downsampling the data in this study: [Divergent single cell transcriptome and epigenome alterations in ALS and FTD patients with C9orf72 mutation](https://www.nature.com/articles/s41467-023-41033-y#data-availability).

??? Info "More about the tutorial dataset"

    This tutorial utilizes postmortem human brain samples from the motor cortex of donors with amyotrophic lateral sclerosis (ALS) associated with the *C9orf72* mutation, along with samples from control donors. The raw data is available in Gene Expression Omnibus under accession [GSE219281](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE219281).

    We selected a subset of sequencing files from four different samples (GSM6781909 - SRR22512192, GSM6781915 - SRR22512216, GSM6781935 - SRR22512297, GSM6781937 - SRR22512305). {{ software_name }} was used to identify which barcodes correspond to cells and which represent empty droplets.

    To generate smaller files via downsampling, we first processed the FASTQ files with Cell Ranger to generate BAM files. We then downsampled the BAM files by retaining 50% of the barcodes called as cells, 50% of barcodes in the empty plateau, and 40% of the remaining barcodes. Additionally, we discarded any barcodes with fewer than 10 unique molecular identifiers (UMIs) and all reads flagged as PCR duplicates. The filtered BAM files were then converted back to FASTQ format, resulting in the dataset used for this tutorial. For more information on the dataset creation process, please visit our github repository [link to code on github here].

### Creating a new project directory and preparing input data

First we will create a new project directory where all outputs of {{ software_name }} for this dataset will be stored:

```bash
# create a new directory called test_project in your current working directory
newproj test_project -s -c
# change your working directory to test_project
cd test_project

```
Using the command `tree .`, you can inspect the structure of the `test_project` directory:

```bash
.
├── _workflowr.yml
├── analysis
│   ├── _site.yml
│   ├── about.Rmd
│   ├── index.Rmd
│   └── license.Rmd
├── code
├── config_test_project.yml
├── data
│   ├── fastqs
│   └── metadata
├── output
├── public
└── test_project.Rproj

```
In the `analysis/` directory, {{ software_name }} will store all R Markdown files that are used to create HTML reports in the `public/` directory. In the `code/` directory all R scrips used in {{ software_name }} will be stored.

For storing input FASTQ files and sample metadata for {{ software_name }} we will use the `data/fastqs` and `data/metadata` subdirectories, repectively.

To download input files for {{ software_name }} run the following lines: 

!!! warning "File size"
    
    The size of FASTQ files is approximately 7.2 GB. Download may take a while.

```bash
# download all raw sequencing files into data/fastqs
curl -s https://api.github.com/repos/marusakod/scprocessData/releases/tags/v0.1.3 \
| grep "browser_download_url.*tar.gz" \
| cut -d : -f 2,3 \
| tr -d \" \
| wget -c --show-progress -P data/fastqs -i -

# extract raw sequencing files
for file in data/fastqs/*.tar.gz; do tar -xzvf "$file" -C data/fastqs && rm "$file"; done

# download sample metadata into data/metadata
wget -P data/metadata https://github.com/marusakod/scprocessData/releases/download/v0.1.3/test_project_metadata.csv
```

With `ls data/fastqs` you should be able to see the following files):

```
GSM6781909_S1_L000_R1_001.fastq.gz	GSM6781935_S1_L000_R1_001.fastq.gz
GSM6781909_S1_L000_R2_001.fastq.gz	GSM6781935_S1_L000_R2_001.fastq.gz
GSM6781915_S1_L000_R1_001.fastq.gz	GSM6781937_S1_L000_R1_001.fastq.gz
GSM6781915_S1_L000_R2_001.fastq.gz	GSM6781937_S1_L000_R2_001.fastq.gz

```
To inspect the content of the `test_project_metadata.csv` file you can use the following command:

```bash

cat data/metadata/test_project_metadata.csv | column -s, -t

```
this is what the output should look like:

```
sample_id   Diagnosis  Diagnosis_full_name                               Tissue_fine   Sex  Age
GSM6781909  ALS        C9orf72-associated amyotrophic lateral sclerosis  Motor cortex  F    66.33
GSM6781915  ALS        C9orf72-associated amyotrophic lateral sclerosis  Motor cortex  M    63
GSM6781935  Ctrl       Control                                           Motor cortex  M    56
GSM6781937  Ctrl       Control                                           Motor cortex  F    72.72

```
Note that the first column of the sample metadata file (`sample_id`) contains values that can be matched to FASTQ files.

### Creating a configuration file

The configuration file template `config_test_project.yaml` was created in the `test_project` root directory with the `newproj` function. In this file, all [required parameters](reference.md#required-parameters) for {{ software_name }} are listed, with some default values already set:

```bash
proj_dir: /absolute/path/to/test_project # replace with correct absolute path 
fastq_dir: data/fastqs
full_tag: test_project
short_tag: 
your_name: 
affiliation:
sample_metadata: data/metadata/
species:
date_stamp: "2025-01-01"
alevin:
  chemistry:
```

Besides setting values for some required parameters, we will add the optional `metadata_vars` parameter, which allows specifying additional metadata variables for visualization. Note that `proj_dir` requires an absolute path, whereas `fastq_dir` and `sample_metadata` can use relative paths since the raw data and sample metadata are stored within the project directory:

```bash
proj_dir: /absolute/path/to/test_project # replace with correct absolute path 
fastq_dir: data/fastqs
full_tag: test_project
short_tag: test
your_name: Test user
affiliation: Unemployed
sample_metadata: data/metadata/test_project_metadata.csv
species: human_2024
date_stamp: "2025-01-01"
metadata_vars: [Sex, Diagnosis]
alevin:
  chemistry: 3v3
```

### Running {{ software_name }}

We are now ready to run {{ software_name }} using:

```bash

scprocess config_test_project.yaml

```

### Inspecting outputs of `rule all`

??? warning "Tutorial results may vary from your {{ software_name }} outputs"
    
    If you modify the default settings for the `human_2024` genome in `.scprocess_setup.yaml`, the results you obtain from running {{ software_name }} on the tutorial dataset may differ slightly from those shown in this guide.


### Optional steps

## Analysis of multiplexed samples


















