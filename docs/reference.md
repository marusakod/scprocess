# Reference

## `scsetup`

**Description**: Download all data required for {{ software_name }} and index reference genomes for `simpleaf`.

**Parameters**:
The command requires a configuration file named `.scprocess_setup.yaml` located in {{ software_name }} data directory (for instructions on how to set up the {{ software_name }} data directory see the [Getting started](setup.md#scprocess-data-directory-setup) section). In this file, the user has to specify which reference genome will be made available for {{ software_name }}. For example:

```yaml
genome:
  tenx:
    - name: human_2024 
      decoys: True
      rrnas: True
  custom:
    - name: custom_genome_name
      fasta: /path/to/genome.fa
      gtf: /path/to/genes.gtf
      decoys: True
      mito_str: "^mt-"
    - name: custom_genome_name2
      index_dir: /path/to/prebuild/alevin/index
      gtf: /path/to/genes.gtf
      mito_str: "^MT-"
```

Prebuilt human and mouse reference genomes from 10x Genomics can be downloaded with `scsetup` by adding `tenx` to the `.scprocess_setup.yaml` file. Valid values for names are `human_2024`, `mouse_2024`, `human_2020`, `mouse_2020`.  

Names and specifications for custom references should be listed in the `custom` section of the `.scprocess_setup.yaml` file. For each `custom` genome users have to provide the following parameters:

* one of:
    + `fasta`: path to FASTA file
    + `index_dir`: path to prebuild alevin index; when specified `decoys` option is ignored
* `gtf`: path to GTF file [(specific format?)]
* `mito_str`: regular expression used to identify genes in the mitochondial genome (example for mouse: `"^mt-"`)

Optional parameters for both `tenx` and `custom` references are:

* `decoys`: whether or not poison k-mer information should be inserted into the index. This parameter is optional. If not specified, it defaults to `True` for all genomes.

Optional paramater for `tenx` references is:

* `rrnas`: whether or not ribosomal RNAs should be included in the reference. If not specified it defaults to `True` for all `tenx` genomes.

!!! note "Impact of custom parameters for `tenx` genomes on `scsetup` runtime"

    When configuring `tenx` genomes with their default values, `scsetup` will download prebuilt indices optimized for `simpleaf`. However, if the default parameters are modified (e.g., setting `rrnas` or `decoys` to `False`), `scsetup` will build the indices from scratch during execution, which will increase the runtime.


!!! info "More about decoys"
    {{ software_name }} utilizes `simpleaf`, a lightweight mapping approach that, by default, maps sequenced fragments exclusively to the transcriptome. However, this can lead to incorrect mapping of reads that arise from unannotated genomic loci to the transcriptome. To mitigate this issue, the `decoys` parameter in `scsetup` is set to `True`. This option allows `simpleaf` to identify genomic regions with sequences similar to those in transcribed regions (decoys), thereby reducing the likelihood of false mappings. We strongly recommend keeping the decoy setting enabled. For further details, refer to [Srivastava et al., 2019](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-020-02151-8).


## `newproj`

**Description**: Create a new `workflowr` project directory for {{ software_name }} outputs.

**Parameters**: 

* `name` (positional): name of the new `workflowr` project directory
* `-w`/`--where` (optional): path to the directory where the new project will be created; defaults to the current working directory
* `-s`/`--sub` (optional): if provided, creates `data/fastqs` and `data/metadata` subdirectories within the project.
* `-c`/`--config` (optional): if provided, generates a template configuration YAML file for {{ software_name }}


## `plotKnee`

**Description**: Create an interactive barcode-rank plot. Can only be used once `rule run_alevin_fry` is completed (see [Rules](reference.md#rules)).

**Parameters**:

Specify either `-k`/`--kneefile` or `-c`/`--configfile`:

* `-k`/`--kneefile`: path to the knee plot data file generated by {{ software_name }}, e.g. `output/[short_tag]_alevin_fry/af_[sample_id]/knee_plot_data_[sample_id]_[date_stamp].txt.gz`.
* `-c`/`--configfile`: path to configuration file used for running {{ software_name }}
* `-s`/`--sample`: sample_id corresponding to barcode-rank curve

## {{ software_name }}

**Description**: Run {{ software_name }}.

**Parameters**:

* `-n`/`--dry-run`: This makes {{ software_name }} perform a trial run that doesn't create any new files. This is helpful for (1) checking that the various input files and parameter settings are likely to work, and (2) checking what work will be done by {{ software_name }}.
* `-E`/`--extraagrs`: `snakemake` is a sophisticated package with many options that can be set by the user. This argument allows users to set additional arguments; see [here](https://snakemake.readthedocs.io/en/stable/executing/cli.html) for `snakemake`'s documentation of command line arguments.
* `-r`/`--rule`: Specifies which rule {{ software_name }} should run. The options are:
    + `all`: default; includes all [Standard pipeline steps](introduction.md#standard-pipeline-steps)
    + `label_celltypes`: cell type annotation using a pre-trained classifier or a custom annotation file. 
    + `zoom`: reintegration, subclustering and marker gene identification for selected cluster groups.
    + `pb_empties`: generation of pseubodulk samples from annotated cells and empty droplets.
    + `simpleaf`: read alignment and quantification using `simpleaf`.
    + `ambient`: ambient RNA removal.
    + `qc`: qc filtering.
    + `integration`: integration with `Harmony`.
    + `marker_genes`: marker gene identification.



### configuration file

This is an example config file for {{ software_name }} with all parameters and their default values/placeholders. Required parameters are highlighted:

=== "default values"

    ```yaml hl_lines="1 2 3 4 5 6 7 8 9 10 11"
      proj_dir: 
      fastq_dir:  
      full_tag: 
      short_tag:
      your_name:
      affiliation:
      sample_metadata:
      species:
      date_stamp:
      alevin:
        chemistry:
      custom_sample_params:
      exclude_samples:
      metadata_vars:
      ambient:
        ambient_method: decontx
        cellbender_version: 'v0.3.0'
        cell_calling: barcodeRanks
        cb_max_prop_kept: 0.9 
        cb_force_expected_cells:
        cb_force_total_droplets_included:
        cb_force_low_count_threshold:
        cb_force_learning_rate:
      make_sce:
        sce_bender_prob: 0.5
      doublet_id:
        dbl_min_feats: 100
      qc:
        qc_min_counts: 300   
        qc_min_feats: 300        
        qc_min_mito: 0             
        qc_max_mito: 0.1         
        qc_min_splice: 0          
        qc_max_splice: 1          
        qc_min_cells: 500  
      integration:
        int_n_hvgs:       2000               
        int_n_dims:       50                 
        int_dbl_res:      4                   
        int_dbl_cl_prop:  0.5                 
        int_theta:        0.1                 
        int_res_ls:       [0.1, 0.2, 0.5, 1]  
        int_sel_res:      0.2
      marker_genes:
        mkr_min_cl_size: 100                                  
        mkr_min_cells: 10                                      
        mkr_not_ok_re: "(lincRNA|lncRNA|pseudogene|antisense)"  
        mkr_min_cpm_mkr: 50                                     
        mkr_min_cpm_go: 1                                      
        mkr_max_zero_p: 0.5                                    
        mkr_gsea_cut: 0.1
      label_celltypes:
        custom_labels:
        lbl_tissue:      
        lbl_sel_res_cl:  "RNN_snn_res.2"  
        lbl_min_pred:    0.5              
        lbl_min_cl_prop: 0.5             
        lbl_min_cl_size: 100              
        sce_subsets:
      zoom:
        cl_grp1:
          sel_cls:
          zoom_res: 0.2               
          n_hvgs: 1000                
          n_dims: 20                 
          min_n_sample: 10            
          min_n_cl: 100               
          n_train: 1000
      metacells: 
        celltypes:  
        max_cells: 
      pseudobulk:
        celltypes:
      resources:
        mb_run_alevin_fry: 8192               
        mb_save_alevin_to_h5: 8192            
        mb_run_ambient: 32768            
        mb_get_barcode_qc_metrics: 4096    
        mb_run_scdblfinder: 4096             
        mb_combine_scdblfinder_outputs: 8192  
        mb_make_sce_object: 16384             
        mb_run_harmony: 16384                 
        mb_run_marker_genes: 16384            
        mb_html_marker_genes: 8192            
        mb_lbl_label_celltypes: 16384         
        mb_lbl_save_subset_sces: 16384        
        mb_lbl_render_template_rmd: 4096      

    ```

=== "placeholders"

    ```yaml hl_lines="1 2 3 4 5 6 7 8 9 10 11"
      proj_dir: /path/to/proj/directory #
      fastq_dir: /path/to/directory/with/fastq/files 
      full_tag: test_project 
      short_tag: test 
      your_name: John Doe 
      affiliation: where you work 
      sample_metadata: /path/to/metadata.csv
      species: human_2024
      date_stamp: "2050-01-01" 
      alevin:
        chemistry: 3v3
      custom_sample_params: /path/to/file/with/custom_parameters.yaml # modify
      exclude_samples: [sample1, sample2]
      metadata_vars: [test1, test2]
      ambient:
        ambient_method: decontx
        cellbender_version: 'v0.3.0'
        cell_calling: barcodeRanks
        cb_max_prop_kept: 0.9 
        cb_force_expected_cells: 10000
        cb_force_total_droplets_included: 20000
        cb_force_low_count_threshold: 5
        cb_force_learning_rate: 0.001
      make_sce:
        sce_bender_prob: 0.5
      doublet_id:
        dbl_min_feats: 100
      qc:
        qc_min_counts: 300   
        qc_min_feats: 300        
        qc_min_mito: 0             
        qc_max_mito: 0.1         
        qc_min_splice: 0          
        qc_max_splice: 1          
        qc_min_cells: 500  
      integration:
        int_n_hvgs:       2000               
        int_n_dims:       50                 
        int_dbl_res:      4                   
        int_dbl_cl_prop:  0.5                 
        int_theta:        0.1                 
        int_res_ls:       [0.1, 0.2, 0.5, 1]  
        int_sel_res:      0.2
      marker_genes:
        mkr_min_cl_size: 100                                  
        mkr_min_cells: 10                                      
        mkr_not_ok_re: "(lincRNA|lncRNA|pseudogene|antisense)"  
        mkr_min_cpm_mkr: 50                                     
        mkr_min_cpm_go: 1                                      
        mkr_max_zero_p: 0.5                                    
        mkr_gsea_cut: 0.1
      label_celltypes:
        custom_labels:
        lbl_tissue:      "brain_cns"      
        lbl_sel_res_cl:  "RNN_snn_res.2"  
        lbl_min_pred:    0.5              
        lbl_min_cl_prop: 0.5             
        lbl_min_cl_size: 100              
        sce_subsets:
          oligos:       ['Oligodendrocyte', 'OPC_COP']
          microglia:    ['Micro_Mono']
          astrocytes:   ['Astrocyte', 'Ependymal_ChorPlex']
          vascular:     ['Vascular_Fibro']
          T_NK_B_cell:  ['T_NK_B_cell']
          neurons:      ['Neurons']
      zoom:
        cl_grp1:
          sel_cls: [cl06]  
          zoom_res: 0.2               
          n_hvgs: 1000                
          n_dims: 20                 
          min_n_sample: 10            
          min_n_cl: 100               
          n_train: 1000
      metacells: 
        celltypes:  ["oligos"]
        max_cells:  [100, 400]
      pseudobulk:
        celltypes:  ["all", "oligos", "microglia"]
      resources:
        mb_run_alevin_fry: 8192               
        mb_save_alevin_to_h5: 8192            
        mb_run_ambient: 32768            
        mb_get_ambient_qc_metrics: 4096    
        mb_run_scdblfinder: 4096             
        mb_combine_scdblfinder_outputs: 8192  
        mb_make_sce_object: 16384             
        mb_run_harmony: 16384                 
        mb_run_marker_genes: 16384            
        mb_html_marker_genes: 8192            
        mb_lbl_label_celltypes: 16384         
        mb_lbl_save_subset_sces: 16384        
        mb_lbl_render_template_rmd: 4096    

    ```


#### Required parameters

* `proj_dir`: absolute path to `workflowr` project directory created with the `newproj` function.
* `fastq_dir`: path to directory containing FASTQ files. Should be absolute or relative to `proj_dir`.
* `full_tag`: full project label, used in output file names.
* `short_tag`: abbreviated project label, used in output directory names.
* `your_name`: author’s name, displayed in HTML outputs.
* `affiliation`: author’s affiliation, displayed in HTML outputs.
* `sample_metadata`: path to CSV file with sample metadata. Should be absolute or relative to `proj_dir`. Spaces in column names are not allowed. Only required column is `sample_id`; values in `sample_id` should not contain `_R_`and `_R2_`strings.
* `species`: must match one of the values in the `genome_name` column of `setup_parameters.csv` (created by `scsetup`).
* `date_stamp`: start date of the analysis, formatted as `"YYYY-MM-DD"`.
* `chemistry`: 10x assay configurtaion. Accepted values are `3LT`, `3v2`, `3v3`, `3v4`, `5v1`, `5v2`, `5v3`, and `multiome`. `multiome` refers only to gene expression data genertaed with the 10x multiome kit (ATACseq data is not supported).

#### Optional parameters

##### general
 
* `custom_sample_params`: YAML file with optional custom parameters for each sample (custom chemistry, custom ambient and custom cellbender parameters can be specified for each sample). Example:

```yaml
sample_1:
  chemistry: 5v2
  ambient:
    knee1: 4000
    shin1: 400
    knee2: 30
    shin2: 5
sample_2: 
  chemistry: 5v2
  ambient:
    knee1: 3000
    shin1: 400
    knee2: 30
    shin2: 5
sample_3: 
  cellbender:
    total_droplets_included: 20000
```

* `exclude_samples`: list of all samples that should be excluded from the analysis.
* `metadata_vars`: list of all variables in `sample_metadata` file. Enables plotting of cell proportions associated with specific metadata values per cluster and in binned UMAPs, with facets representing each variable’s unique values to help assess whether cells with certain annotations are concentrated in specific clusters/UMAP regions, or if they are evenly distributed.


##### ambient

* `ambient_method`: method for ambient RNA removal; options are `decontx` (default), `cellbender` or `none`.
* `cellbender_version`: version of `cellbender` to use if `ambient_method` is set to `cellbender`. Options are `'v0.3.0'` (default) and `'v0.2.0'`.
* `cb_force_expected_cells`: forces the `--expected-cells` parameter to be consistent across all samples; applicable only if `ambient_method` is `cellbender`. For more information about this parameter see [Cellbender's documentation](https://cellbender.readthedocs.io/en/latest/reference/index.html).
* `cb_force_total_droplets_included`: forces the `--total-droplets-included` parameter to be consistent across all samples; applicable only if `ambient_method` is `cellbender`. For more information about this parameter see [Cellbender's documentation](https://cellbender.readthedocs.io/en/latest/reference/index.html).
* `cb_force_low_count_threshold`: forces the `--low-count-threshold` parameter to be consistent across all samples; applicable only if `ambient_method` is `cellbender`. For more information about this parameter see [Cellbender's documentation](https://cellbender.readthedocs.io/en/latest/reference/index.html).
* `cb_force_learning_rate`: Forces the `--learning-rate` parameter to be consistent across all samples; applicable only if `ambient_method` is `cellbender`. For more information about this parameter see [Cellbender's documentation](https://cellbender.readthedocs.io/en/latest/reference/index.html).
* `cb_max_prop_kept`: maximum proportion of droplets, relative to `--total-droplets-included`, that `cellbender` can call as cells. Default is `0.9`, meaning samples are excluded if `cellbender` calls more than 90% of `--total-droplets-included` droplets as cells. Applicable only if `ambient_method` is `cellbender`.
* `cell_calling`: method for cell calling when `ambient_method` is `none` or `decontx`. Options are `barcodeRanks` and `emptyDrops`.


##### make_sce

* `sce_bender_prob`: minimum probability threshold for retaining droplets classified as cells i.e. Only relevant when `ambient_method` is `cellbender`.


##### doublet_id
* `dbl_min_feats`: number of features required for each barcode to be included in scDblFinder calculations.

##### qc

* `qc_min_counts`: minimum number of UMIs per cell required to retain the cell.
* `qc_min_feats`: minimum number of features per cell required to retain the cell.
* `qc_min_mito`: minimum proportion of mitochondrial reads required to retain the cell.
* `qc_max_mito`: maximum proportion of mitochondrial reads allowed to retain the cell.
* `qc_min_splice`: minimum proportion of spliced reads required to retain the cell.
* `qc_max_splice`: maximum proportion of spliced reads allowed to retain the cell.
* `qc_min_cells`: minimum number of cells required in a sample after QC filtering to retain the sample.

##### integration

* `int_n_hvgs`: number of HVGs to use for PCA
* `int_n_dims`number of PCs to use for integration
* `int_dbl_res`resolution for clustering to get extra doublets
* `int_dbl_cl_prop` proportion of doublet cells in a cluster to exclude that cluster
* `int_theta` theta parameter for Harmony integration. 0 means no extra mixing of batch variable, 2 is default, which encourages batch mixing. At the moment our default is 0.1.
* `int_res_ls` list of cluster resolutions for Harmony clustering
* `int_sel_res` selected cluster resolution (for marker genes?)

* `int_n_hvgs`: number of highly variable genes (HVGs) to use for principal component analysis (PCA).
* `int_n_dims`: number of principal components to use for data integration.
* `int_dbl_res`: clustering resolution for identification of additional doublets.
* `int_dbl_cl_prop`: proportion threshold of doublets in a cluster; clusters exceeding this proportion are excluded.
* `int_theta`: theta parameter for `Harmony` integration, controlling batch variable mixing. `0` means no extra mixing of batch variable; Default in {{ software_name }} is `0.1`, otherwise `2`. 
* `int_res_ls`: list of cluster resolutions for `Harmony`-based clustering.
* `int_sel_res`: selected cluster resolution used for identifying marker genes.


##### marker_genes
* `mkr_min_cl_size` minimum number of cells in a cluster for that cluster to have marker genes calculated
* `mkr_min_cells` minimum number of cells present in a pseudobulk sample for that sample to be used to calculate marker genes
* `mkr_not_ok_re` regular expression for gene types to exclude from marker gene plotting
* `mkr_min_cpm_mkr` minimum number of counts per million in a cell type for a gene to be considered a marker gene
* `mkr_min_cpm_go` minimum number of counts per million in a cell type for a gene to be used in GO analysis
* `mkr_max_zero_p` maximum proportion of pseudobulk samples for a cell type that can have zero counts for a gene to be used in GO analysis
* `mkr_gsea_cut` FDR cutoff for GSEA analysis


##### marker_genes
* `mkr_min_cl_size`: minimum number of cells required in a cluster to calculate marker genes for that cluster.
* `mkr_min_cells`: minimum number of cells required in a pseudobulk sample to include it in marker gene calculations.
* `mkr_not_ok_re`: regular expression pattern to exclude specific gene types from plots showing marker gene expression. 
* `mkr_min_cpm_mkr`: minimum counts per million (CPM) in a cell type required for a gene to be considered a marker gene.
* `mkr_min_cpm_go`: minimum counts per million (CPM) in a cell type required for a gene to be used in Gene Ontology (GO) analysis.
* `mkr_max_zero_p`: maximum proportion of pseudobulk samples for a cell type that can have zero counts for a gene to be used in GO analysis.
* `mkr_gsea_cut`: False discovery rate (FDR) cutoff for Gene Set Enrichment Analysis (GSEA).


##### label_celltypes

* `custom_labels`: path to CSV file containing cell type annotations, with two columns: `cell_id` and `label`. Entries in the `cell_id` column should be formatted as `sample_id:cell_barcode` and must match `cell_id` values in the `SingleCellExperiment` object (`sce_clean_[full_tag]_[date_stamp].rds`) located in `output/[short_tag]_integration` directory. `NA` values will be assigned to all cells with missing annotations.
* `lbl_tissue`: target tissue for cell type labeling. Options are `human_cns`, `mouse_cns`, `human_pbmc`, and `mouse_pbmc`.
* `lbl_sel_res_cl`: selected cluster resolution for cell type labeling; higher values are recommended for optimal performance.
* `lbl_min_pred`: minimum probability threshold for assigning a cell to a cell type.
* `lbl_min_cl_prop`: minimum proportion of cells in a cluster that need to be labeled for that cluster to be labeled.
* `lbl_min_cl_size`: minimum number of cells in a cluster required for that cluster to be labeled.
* `sce_subsets`: specification for saving subsets of cells in separate `SingleCellExperiment` objects. Each subset has to be defined by name, followed by a list of cell types to include. Valid cell type labels match unique values in the `label` column of `custom_labels` file if provided; otherwise, they depend on the value of `lbl_tissue` parameter:
    + `human_cns`: `OPC_COP`, `Oligodendrocyte`, `Astrocyte`, `Ependymal`, `Choroid_plexus`, `Micro_Mono`, `Vascular_Fibro`, `T_NK_B_cell`, `Neurons`
    + `mouse_cns`: tbd
    + `human_pbmc`: tbd
    + `mouse_pbmc`: tbd

##### zoom
* `sel_cls`: clusters to include in the analysis.
* `zoom_res`: resolution setting for the analysis.
* `n_hvgs`: number of HVGs.
* `n_dims`: number of PC dimensions to integrate over.
* `min_n_sample`: minimum number of cells required to retain a sample in the analysis.
* `min_n_cl`: minimum number of cells required to retain a cluster in the analysis.
* `n_train`: number of cells per cluster to use for training.

##### metacells

* `celltypes`: cell type names corresponding to names of `sce_subsets`.
* `max_cells`: specifies the maximum number of cells per sample. If a sample contains more than `max_cells`, cells will be merged into metacells using `SuperCell`, with the graining factor calculated as `gamma = sample_n_cells / max_cells` where `sample_n_cells` is the number of single cells in one sample. 



##### pseudobulk
* `celltypes`: cell type names corresponding to names of `sce_subsets`.

 
##### resources
* `retries`: number of times to retry running a specific rule in {{ software_name }} if it fails. For each attempt, the memory requirement for the rule increases by multiplying the base memory by the attempt number. Useful for when {{ software_name }} is used on a [cluster](setup.md#cluster-setup).
* `mb_run_alevin_fry`: maximum memory required (in MB) for running `simpleaf`. Value applies to the entire job, not per thread.
* `mb_save_alevin_to_h5`:  maximum memory required (in MB) to save `simpleaf` output to H5 format. Value applies to the entire job, not per thread.
* `mb_run_ambient`: maximum memory required (in MB) to run the ambient RNA removal step. Value applies to the entire job, not per thread.
* `mb_get_barcode_qc_metrics`: maximum memory required (in MB) to obtain quality control metrics related to ambient RNA removal. Value applies to the entire job, not per thread.
* `mb_run_scdblfinder`: maximum memory required (in MB) to run `scDblFinder` for doublet detection. Value applies to the entire job, not per thread.
* `mb_combine_scdblfinder_outputs`: maximum memory required (in MB) to combine `scDblFinder` outputs across samples. Value applies to the entire job, not per thread.
* `mb_make_sce_object`: maximum memory required (in MB) to create a `SingleCellExperiment` object. Value applies to the entire job, not per thread.
* `mb_run_harmony`: maximum memory required (in MB) to run `Harmony` integration for batch correction. Value applies to the entire job, not per thread.
* `mb_run_marker_genes`: maximum memory required (in MB) for marker gene identification. Value applies to the entire job, not per thread.
* `mb_lbl_label_celltypes`: maximum memory required (in MB) to label cell types. Value applies to the entire job, not per thread.
* `mb_lbl_save_subset_sces`: maximum memory required (in MB) to save `SingleCellExperiment` objects with cell subsets. Value applies to the entire job, not per thread.
* `mb_lbl_render_template_rmd`: maximum memory required (in MB) to render HTML document from markdown template. Value applies to the entire job, not per thread.



