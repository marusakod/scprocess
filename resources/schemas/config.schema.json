{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "additionalProperties": false,
  "required": ["project"],
  "properties": {
    "project": {
      "type": "object",
      "additionalProperties": false,
      "required": ["proj_dir", "full_tag", "short_tag", "your_name", "affiliation",
        "date_stamp", "sample_metadata", "species", "tenx_chemistry"],
      "properties": {
        "proj_dir":             { "type": "string" },
        "fastq_dir":            { "type": "string" },
        "arv_uuids":            { "type": "array", "items": {"type": "string", "pattern": "^arkau-[0-9a-z]{5}-[0-9a-z]{15}$"} },
        "full_tag":             { "type": "string" },
        "short_tag":            { "type": "string" },
        "your_name":            { "type": "string" },
        "affiliation":          { "type": "string" },
        "date_stamp":           { "type": "string", "format": "date" },
        "sample_metadata":      { "type": "string", "items": {"type": "string", "pattern": "^.+\\.csv$"} },
        "species":              { "type": "string" },
        "tenx_chemistry":       { "type": "string", "enum": ["3LT", "3v2", "3v3", "3v4", "5v1", "5v2", "5v3", "multiome"] },
        "metadata_vars":        { "type": "array", "items": { "type": "string" } },
        "custom_sample_params": { "type": "string" },
        "exclude": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "sample_id":  { "type": "array", "items": { "type": "string" } },
            "pool_id":    { "type": "array", "items": { "type": "string" } }
          }
        }
      },
      "oneOf": [
        { "required": ["fastq_dir"] },
        { "required": ["arv_uuids"] }
      ]
    },
    "multiplexing": {
      "title": "Multiplexing Configuration",
      "type": "object",
      "additionalProperties": false,
      "required": [ "demux_type" ],
      "properties": {
        "demux_type":       { "type": "string", "enum": ["none", "hto", "custom"], "default": "none" },
        "fastq_dir":        { "type": "string" },
        "arv_uuids":        { "type": "array", "items": {"type": "string", "pattern": "^arkau-[0-9a-z]{5}-[0-9a-z]{15}$"} },
        "feature_ref":      { "type": "string" },
        "seurat_quantile":  { "type": "number", "default": 0.99, "exclusiveMinimum": 0, "exclusiveMaximum": 1},
        "demux_output":     { "type": "string" }
      },
      "allOf": [
        {
          "if": {"properties": {"demux_type": {"const": "hto" } } },
          "then": {
            "allOf": [
              { "required": ["feature_ref" ] },
              {
                "oneOf": [
                  { "required": ["fastq_dir"] },
                  { "required": ["arv_uuids"] }
                ]
              }
            ]
          },
         "else": {
            "not": { "required": ["feature_ref"] }
          }
        },
        {
          "if": {"properties": {"demux_type": {"const": "custom" } } },
          "then": {"required": ["demux_output" ] },
          "else": {
            "not": { "required": ["demux_output"] }
          }
        },
        {
          "if": {"properties": {"demux_type": {"const": "none" } } },
          "then": {
            "not": { "required": ["fastq_dir", "arv_uuids", "demux_output", "feature_ref"] }
          }
        }
      ]
    },
    "ambient": {
      "type": "object",
      "required": ["ambient_method"],
      "additionalProperties": false,
      "properties": {
        "ambient_method":               { "type": "string", "enum": ["decontx", "cellbender", "none"], "default": "decontx" },
        "cell_calling":                 { "type": "string", "enum": ["barcodeRanks", "emptyDrops"], "default": "barcodeRanks" },
        "cb_version":                   { "type": "string", "enum": ["v0.3.2", "v0.3.0'", "v0.2.0'"], "default": "v0.3.2" },
        "cb_max_prop_kept":             { "type": "number", "default": 0.9 },
        "cb_learning_rate":             { "type": "number", "default": 1e-4 },
        "cb_posterior_batch_size":      { "type": "integer", "exclusiveMinimum": 0, "default": 128 },
        "cb_empty_training_fraction":   { "type": "number", "exclusiveMinimum": 0, "exclusiveMaximum": 1, "default": 0.2 },
        "cb_expected_cells":            { "type": "number" },
        "cb_total_droplets_included":   { "type": "number" },
        "cb_low_count_threshold":       { "type": "number" }
      }
    },
    "qc": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "qc_min_counts":  { "type": "integer", "exclusiveMinimum": 0, "default": 500 },
        "qc_min_feats":   { "type": "integer", "exclusiveMinimum": 0, "default": 300 },
        "qc_min_mito":    { "type": "number", "minimum": 0, "maximum": 1, "default": 0 },
        "qc_max_mito":    { "type": "number", "minimum": 0, "maximum": 1, "default": 0.1 },
        "qc_min_splice":  { "type": "number", "minimum": 0, "maximum": 1, "default": 0 },
        "qc_max_splice":  { "type": "number", "minimum": 0, "maximum": 1, "default": 1 },
        "qc_min_cells":   { "type": "integer", "exclusiveMinimum": 0, "default": 100 },
        "dbl_min_feats":  { "type": "integer", "exclusiveMinimum": 0, "default": 100 },
        "exclude_mito":   { "type": "boolean", "default": true }
      }
    },
    "pb_empties": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "ambient_genes_logfc_thr":  { "type": "number", "default": 0 },
        "ambient_genes_fdr_thr":    { "type": "number", "default": 0.01 }
      }
    },
    "hvg": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "hvg_method":                 { "type": "string", "enum": ["sample", "all", "groups"], "default": "sample" },
        "hvg_n_hvgs":                 { "type": "integer", "default": 2000 },
        "hvg_chunk_size":             { "type": "integer", "default": 2000 },
        "hvg_exclude_ambient_genes":  { "type": "boolean", "default": true },
        "hvg_metadata_split_var":     { "type": ["string", "null"] }
      },
      "allOf": [
        {
          "if": {"properties": {"hvg_method": {"const": "groups" } } },
          "then": { "required": ["hvg_metadata_split_var" ] },
          "else": {
            "not": { "required": ["hvg_metadata_split_var"] }
          }
        }
      ]
    },
    "integration": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "int_embedding":    { "type": "string", "enum": ["harmony", "pca"], "default": "harmony" },
        "int_cl_method":    { "type": "string", "default": "leiden", "enum": ["leiden", "louvain"] },
        "int_theta":        { "type": "number", "default": 0.1 },
        "int_batch_var":    { "type": "string", "enum": ["pool_id", "sample_id"], "default": "sample_id" },
        "int_n_dims":       { "type": "integer", "default": 50 },
        "int_dbl_res":      { "type": "number", "default": 4 },
        "int_dbl_cl_prop":  { "type": "number", "default": 0.5 },
        "int_res_ls": {
          "type":     "array",
          "items":    { "type": "number" },
          "default":  [0.1, 0.2, 0.5, 1, 2]
        }
      }
    },
    "marker_genes": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mkr_sel_res":      { "type": "number",   "default": 0.2 },
        "mkr_min_cl_size":  { "type": "integer",  "default": 100 },
        "mkr_min_cells":    { "type": "integer",  "default": 10 },
        "mkr_not_ok_re":    { "type": "string",   "default": "(lincRNA|lncRNA|pseudogene|antisense)" },
        "mkr_min_cpm_mkr":  { "type": "integer",  "default": 50 },
        "mkr_min_cpm_go":   { "type": "integer",  "default": 1 },
        "mkr_max_zero_p":   { "type": "number",   "default": 0.5 },
        "mkr_do_gsea":      { "type": "boolean",  "default": true }, 
        "mkr_gsea_cut":     { "type": "number",   "default": 0.1 },
        "mkr_custom_genesets": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name"],
            "properties": {
              "name": { "type": "string", "pattern": "^[^,]*$" },
              "file": { "type": "string" }
            }
          }
        }
      }
    },
    "label_celltypes": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["labeller"],
        "properties": {
          "labeller":     { "type": "string", "enum": ["celltypist", "scprocess", "custom"] },
          "custom_f":     { "type": "string" },
          "model":        {"type": "string" },
          "hi_res_cl":    { "type": "string", "default": "RNA_snn_res.2" },
          "min_pred":     { "type": "number", "default": 0.8 },
          "min_cl_prop":  { "type": "number", "default": 0.5 },
          "min_cl_size":  { "type": "integer", "default": 100 }
        },
        "allOf": [
          {
            "if": {"properties": {"labeller": { "enum": ["celltypist", "scprocess"] } } },
            "then": {
              "allOf": [
                { "required": ["model"] },
                {"not": { "required": ["custom_f"] }}
              ]
            }
          },
          {
            "if": {"properties": {"labeller": { "const": "custom" } } },
            "then": {
              "allOf": [
                { "required": ["custom_f"] },
                {"not": { "required": ["model"] }}
              ]
            }
          }
        ]
      }
    },
    "zoom": {
      "description": "Contains mappings of logical names to YAML file paths.",
      "type": "array", "items": { "type": "string" }, "uniqueItems": true
    },
    "resources": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "n_run_mapping":                 { "type": "integer", "default": 8}, 
        "gb_build_hto_index":            { "type": "integer", "default": 4 },
        "gb_run_mapping":                { "type": "integer", "default": 12 },
        "gb_run_mapping_hto":            { "type": "integer", "default": 12 },
        "gb_save_alevin_to_h5":          { "type": "integer", "default": 8 },
        "gb_make_hto_sce_objects":       { "type": "integer", "default": 8 },
        "gb_save_alevin_hto_to_h5":      { "type": "integer", "default": 8 },
        "mins_build_hto_index":           { "type": "integer", "default": 10 },
        "mins_run_mapping":               { "type": ["integer", "null"] },
        "mins_run_mapping_hto":           { "type": "integer", "default": 180 },
        "mins_save_alevin_to_h5":         { "type": "integer", "default": 10 },
        "mins_make_hto_sce_objects":      { "type": "integer", "default": 10 }, 
        "mins_save_alevin_hto_to_h5":     { "type": "integer", "default": 5 },

        "gb_run_cellbender":             { "type": ["integer", "null"] },
        "gb_run_decontx":                { "type": ["integer", "null"] }, 
        "gb_run_cell_celling":           { "type": "integer", "default": 8 },
        "gb_get_barcode_qc_metrics":     { "type": ["integer", "null"] },
        "mins_run_cellbender":            { "type": ["integer", "null"] },
        "mins_run_decontx":               { "type": ["integer", "null"] }, 
        "mins_run_cell_celling":          { "type": "integer", "default": 30 },
        "mins_get_barcode_qc_metrics":    { "type": ["integer", "null"] },
        
        "gb_run_qc":                     { "type": ["integer", "null"] },
        "gb_merge_qc":                   { "type": ["integer", "null"] },
        "gb_merge_rowdata":              { "type": ["integer", "null"] },
        "gb_get_qc_sample_statistics":   { "type": ["integer", "null"] },
        "mins_run_qc":                    { "type": ["integer", "null"] },
        "mins_merge_qc":                  { "type": ["integer", "null"] },
        "mins_merge_rowdata":             { "type": ["integer", "null"] },
        "mins_get_qc_sample_statistics":  { "type": ["integer", "null"] },

        "gb_make_one_pb_empty":          { "type": ["integer", "null"] },
        "gb_merge_pb_empty":             { "type": "integer", "default": 2 },
        "gb_make_pb_all":                { "type": ["integer", "null"] },
        "gb_calculate_ambient_genes":    { "type": ["integer", "null"] },
        "mins_make_one_pb_empty":         { "type": ["integer", "null"] },
        "mins_merge_pb_empty":            { "type": ["integer", "null"] },
        "mins_make_pb_all":               { "type": ["integer", "null"] },
        "mins_calculate_ambient_genes":   { "type": ["integer", "null"] },

        "gb_make_tmp_csr_matrix":        { "type": ["integer", "null"] },
        "gb_get_stats_for_std_variance_for_sample": { "type": ["integer", "null"] },
        "gb_merge_sample_std_var_stats": { "type": ["integer", "null"] },
        "gb_get_mean_var_for_group":     { "type": "integer", "default": 8 },
        "gb_get_estimated_variances":    { "type": "integer", "default": 8 },
        "gb_get_stats_for_std_variance_for_group": { "type": "integer", "default": 8 },
        "gb_get_highly_variable_genes":  { "type": ["integer", "null"] },
        "gb_create_hvg_matrix":          { "type": ["integer", "null"] },
        "gb_create_doublets_hvg_matrix": { "type": ["integer", "null"] },
        "mins_make_tmp_csr_matrix":       { "type": ["integer", "null"] },
        "mins_get_stats_for_std_variance_for_sample": { "type": ["integer", "null"] },
        "mins_merge_sample_std_var_stats": { "type": ["integer", "null"] },
        "mins_get_mean_var_for_group":    { "type": "integer", "default": 10 },
        "mins_get_estimated_variances":   { "type": "integer", "default": 10 },
        "mins_get_stats_for_std_variance_for_group": { "type": "integer", "default": 10 },
        "mins_get_highly_variable_genes": { "type": ["integer", "null"] },
        "mins_create_hvg_matrix":         { "type": ["integer", "null"] },
        "mins_create_doublets_hvg_matrix": { "type": ["integer", "null"] },

        "gb_run_integration":             { "type": ["integer", "null"] },
        "gb_make_clean_sces":             { "type": "integer", "default": 8 },
        "mins_run_integration":           { "type": ["integer", "null"] },
        "mins_make_clean_sces":           { "type": "integer", "default": 5 },

        "gb_run_marker_genes":           { "type": ["integer", "null"] },
        "mins_run_marker_genes":          { "type": ["integer", "null"] },
        "gb_run_fgsea":                   { "type": "integer", "default": 8 },
        "mins_run_fgsea":                 { "type": "integer", "default": 30 },

        "gb_render_html_mapping":        { "type": ["integer", "null"] },
        "gb_render_html_multiplexing":   { "type": "integer", "default": 8 },
        "gb_render_html_ambient":        { "type": ["integer", "null"] },
        "gb_render_html_qc":             { "type": ["integer", "null"] },
        "gb_render_html_hvgs":           { "type": "integer", "default": 3 },
        "gb_render_html_integration":    { "type": ["integer", "null"] },
        "gb_render_html_marker_genes":   { "type": ["integer", "null"] },
        "gb_render_html_label_celltypes": { "type": "integer", "default": 3 },
        "mins_render_html_mapping":       { "type": ["integer", "null"] },
        "mins_render_html_multiplexing":  { "type": "integer", "default": 5 },
        "mins_render_html_ambient":       { "type": ["integer", "null"] },
        "mins_render_html_qc":            { "type": ["integer", "null"] },
        "mins_render_html_hvgs":          { "type": "integer", "default": 3 },
        "mins_render_html_integration":   { "type": ["integer", "null"] },
        "mins_render_html_marker_genes":  { "type": ["integer", "null"] },
        "mins_render_html_label_celltypes": { "type": "integer", "default": 5 },

        "gb_make_tmp_mtx_file" :         { "type": "integer", "default": 8 },
        "gb_run_celltypist":             { "type": "integer", "default": 8 },
        "gb_run_scprocess_labeller":     { "type": "integer", "default": 8 }, 
        "gb_merge_labels":               { "type": "integer", "default": 8 }, 
        "mins_make_tmp_mtx_file":         { "type": "integer", "default": 8 }, 
        "mins_run_celltypist":            { "type": "integer", "default": 8 }, 
        "mins_run_scprocess_labeller":    { "type": "integer", "default": 8 }, 
        "mins_merge_labels":              { "type": "integer", "default": 8 }, 

        "gb_get_zoom_sample_statistics":                { "type": "integer", "default": 4 },
        "gb_zoom_make_pb_subset":                       { "type": "integer", "default": 12 },
        "gb_zoom_calculate_ambient_genes":              { "type": "integer", "default": 8 },
        "gb_zoom_make_hvg_df":                          { "type": "integer", "default": 4 },
        "gb_zoom_make_tmp_csr_matrix":                  { "type": "integer", "default": 25 },
        "gb_zoom_get_stats_for_std_variance_for_sample": { "type": "integer","default": 12 },
        "gb_zoom_get_mean_var_for_group":               { "type": "integer", "default": 8 },
        "gb_zoom_merge_group_mean_var":                 { "type": "integer", "default": 4 },
        "gb_zoom_get_estimated_variances":              { "type": "integer", "default": 4 },
        "gb_zoom_get_stats_for_std_variance_for_group": { "type": "integer", "default": 12 },
        "gb_zoom_merge_stats_for_std_variance":         { "type": "integer", "default": 4 },
        "gb_zoom_get_highly_variable_genes":            { "type": "integer", "default": 4 },
        "gb_zoom_create_hvg_matrix":                    { "type": "integer", "default": 8 },
        "gb_zoom_run_integration":                      { "type": "integer", "default": 16 },
        "gb_zoom_run_marker_genes":                     { "type": "integer", "default": 16 },
        "gb_zoom_make_subset_sces":                     { "type": "integer", "default": 8 },
        "gb_render_html_zoom":                          { "type": "integer", "default": 8 },
        "mins_get_zoom_sample_statistics":               { "type": "integer", "default": 5 },
        "mins_zoom_make_pb_subset":                      { "type": "integer", "default": 60 },
        "mins_zoom_calculate_ambient_genes":             { "type": "integer", "default": 30 },
        "mins_zoom_make_hvg_df":                         { "type": "integer", "default": 5 },
        "mins_zoom_make_tmp_csr_matrix":                 { "type": "integer", "default": 60 },
        "mins_zoom_get_stats_for_std_variance_for_sample": { "type": "integer", "default": 30 },
        "mins_zoom_get_mean_var_for_group":              { "type": "integer", "default": 30 },
        "mins_zoom_merge_group_mean_var":                { "type": "integer", "default": 5 },
        "mins_zoom_get_estimated_variances":             { "type": "integer", "default": 5 },
        "mins_zoom_get_stats_for_std_variance_for_group":{ "type": "integer", "default": 30 },
        "mins_zoom_merge_stats_for_std_variance":        { "type": "integer", "default": 5 },
        "mins_zoom_get_highly_variable_genes":           { "type": "integer", "default": 10 },
        "mins_zoom_create_hvg_matrix":                   { "type": "integer", "default": 15 },
        "mins_zoom_run_integration":                     { "type": "integer", "default": 180 },
        "mins_zoom_run_marker_genes":                    { "type": "integer", "default": 60 },
        "mins_zoom_make_subset_sces":                    { "type": "integer", "default": 15 },
        "mins_render_html_zoom":                         { "type": "integer", "default": 20 },
      
        "retries":                       { "type": "integer", "default": 0 }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {"integration": {
          "properties": {"int_batch_var": {"const": "pool_id" } }, "required": ["int_batch_var"] 
        } }, "required": ["integration"]
      },
      "then": {
        "properties": {"multiplexing": {
            "properties": {"demux_type": {"not": {"const": "none" } } }, "required": ["demux_type"]
          }
        }, "required": ["multiplexing"]
      }
    }
  ]
}
