---
title: "HVG selection diagnostics"
author:
- name: ${your_name}
  affiliation: 
  - ${affiliation}
date: '`r format(as.Date("${date_stamp}"), "%B %d, %Y")`'
output:
  rmdformats::downcute:
    highlight: textmate
    code_folding: hide
    toc_depth: 3
    css: custom.css
---

```{r setup_knitr, include=FALSE}
library('BiocStyle')
knitr::opts_chunk$set(
  autodep=TRUE, cache=TRUE, cache.lazy=FALSE, dev='png', 
  fig.path = "figure/${short_tag}_hvgs.Rmd/", message = FALSE, warning = FALSE
)
knitr::opts_knit$set(root.dir = '..', base.dir = '../public/', base.url = '')
# workflowr::wflow_build(files='analysis/${short_tag}_hvgs.Rmd', view=F, verbose=T, delete_cache=F)
```

```{r setup_helpers, cache=FALSE, include = FALSE}
source('code/utils.R')
source('code/hvgs.R')
n_cores     = ${threads}
setDTthreads(n_cores)
```

```{r setup_input, include = FALSE}
# input_files
hvgs_f      = "${hvgs_f}"
empty_gs_f  = "${empty_gs_f}"
pb_empty_f  = "${pb_empty_f}"
```

```{r load_hvg_data, include = FALSE}
hvgs_dt     = fread(hvgs_f)
edger_dt    = fread(empty_gs_f)
pb          = readRDS(pb_empty_f)
```

```{r calc_empty_hvgs, include = FALSE}
vst_obj     = calc_vst_obj(pb, edger_dt)
```

The selection of highly variable genes is a crucial step in the integration process and in
identifying clusters in single-cell experiments. However, contamination from ambient RNA can act as a
significant confounding factor. This report provides plots to evaluate the influence of ambient RNA on the selection
of highly variable genes and its potential impact on downstream analyses.

## Are highly variable genes "ambient"?

The plot shows the extent to which highly variable genes identified using the `Seurat` VST method may
be influenced by ambient RNA. The x-axis represents the `log2fc` values derived from the ambient gene estimation
step in `scprocess` (see `scprocess` documentation for more details), while the y-axis shows the
trend-normalized variance calculated using the `Seurat` VST method. Each point represents a gene,
annotated based on whether it is among the top HVGs and whether it is identified as "ambient" by the
ambient gene detection step. Labelled genes are top 20 with highest mean variance, 
including genes that were not included as HVGs because of high expression in empty droplets.

```{r plot_std_var_vs_empty_log2fc, fig.height = 6, fig.width = 8}
print(plot_hvg_stats_vs_empty_log2fc(hvgs_dt, edger_dt))
```

## Which genes are "ambient"?{.tabset}

The plot shows the results of the `scprocess` ambient gene detection procedure. The y-axis
is the `-log10` nominal p-value, with a dotted line indicating the threshold where the adjusted p-value
is sufficiently small (< 0.01). Multiple plots are shown, each corresponding to a different
minimum expression level filter applied to the ambient profiles.

```{r plot_ambient_gene_calculations, fig.height = 6, fig.width = 6, results = 'asis'}
cpm_ls  = c(100, 50, 10, 0)
for (min_cpm in cpm_ls) {
  if (min_cpm == 0) {
    cat("### all genes\n")
  } else {
    cat(sprintf("### >= %d CPM expression in ambient\n", min_cpm))
  }
  print(plot_ambient_gene_calculations(edger_dt, min_cpm_empty = min_cpm))
  cat("\n\n")
}
```

## Which genes are variable across the ambient profiles?{.tabset}

Examining how ambient genes vary across different samples can provide valuable insights.
Such variation may highlight cases where certain samples require distinct treatment, for example,
if case and control samples consistently exhibit different ambient profiles.

The heatmaps display the pseudobulk expression of various genes across the ambient profiles of each sample in the dataset.
The genes shown are the top 40 selected based on the following criteria:

- highest variance across ambient profiles;
- highest mean expression across ambient profiles;
- highest `log2fc` in empty droplets vs cells in `scprocess`'s ambient gene detection procedure; 
and
- smallest p-value in empty droplets vs cells in `scprocess`'s ambient gene detection procedure.

```{r plot_ambient_profiles, fig.height = 8, fig.width = 6, results = 'asis'}
title_ls = c(
  "var"           = "HVGs",
  "mean"          = "Highest expression",
  "log2fc.empty"  = "Highest log2fc",
  "pval.empty"    = "Smallest p-value"
)
for (top_var in names(title_ls)) {
  cat(sprintf("### %s in ambient\n", title_ls[top_var]))
  suppressMessages(draw(plot_heatmap_of_ambient_profiles(vst_obj, top_var = top_var, 
    n_top = 40), heatmap_legend_side = "right", merge_legend = TRUE ))
  cat("\n\n")
}
```

## R session info

Details of the R package versions used are given below.

<details>
```{r session_info, include=TRUE, echo=TRUE, results="markup"}
devtools::session_info()
```
</details>
